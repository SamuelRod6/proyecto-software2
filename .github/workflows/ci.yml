name: CI

on:
    push:
        branches: ["**"]
    pull_request:

jobs:
    backend:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-go@v5
              with:
                  go-version: "1.21"
                  cache: true
            - name: Run Go tests
              run: go test ./...
              working-directory: backend

    frontend-unit:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: npm
                  cache-dependency-path: frontend/package-lock.json
            - name: Install dependencies
              run: npm ci
              working-directory: frontend
            - name: Run Jest tests
              run: npm run test -- --ci
              working-directory: frontend
            - name: Build frontend
              run: npm run build
              working-directory: frontend

    e2e:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.21"
                  cache: true

            - name: Start backend server
              run: |
                  nohup bash -c "go run ." </dev/null >/dev/null 2>&1 &
              working-directory: backend

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: npm
                  cache-dependency-path: frontend/package-lock.json

            - name: Install frontend deps
              run: npm ci
              working-directory: frontend

            - name: Run Cypress
              uses: cypress-io/github-action@v6
              with:
                  working-directory: frontend
                  install: false
                  build: npm run build
                  start: npm run preview
                  wait-on: "http://localhost:4173,http://localhost:8080/api/hello"
